{% load leaflet_tags %}
<html>
  <head>
    {% leaflet_js %}
    {% leaflet_css %}
    <style>
      .leaflet-container { height: 100vh; width: 100vw; position: absolute; top: 0; left: 0 }
      .user {position: absolute;bottom:0;right:0;z-index:999999;background-color:white}
    </style>
    <script type="text/javascript">
    
    var LeafIcon = L.Icon.extend({
    options: {
        shadowUrl: '',
        iconSize:     [20, 20],
        shadowSize:   [50, 64],
        iconAnchor:   [10, 10],
        shadowAnchor: [4, 62],
        popupAnchor:  [-3, -76]
    }
    });

      var dataurl = '{% url "data" %}';
      var pointurl = '{% url "point" %}';
      
      window.addEventListener("map:init", function (event) {
        var map = event.detail.map;
        function onLocationFound(e) {
            var radius = e.accuracy/2;
            L.circle(e.latlng, radius).addTo(map).bindPopup("You are here").openPopup();
        }

        function onLocationError(e) {
            alert(e.message);
        }
        {% load geojson_tags %}

        map.on('locationfound', onLocationFound);
        map.on('locationerror', onLocationError);
        map.locate({setView: true, maxZoom: 12});
        // Download GeoJSON data with Ajax
        var collection = {{ mushes|geojsonfeature|safe }};
        var ola = "";
        L.geoJson(collection).addTo(map);
        fetch(pointurl)
          .then(function(resp) {
            return resp.json();
          })
          .then(function(data) {
            L.geoJson(data,{
              onEachFeature: function onEachFeature(feature, layer) {
                var props = feature.properties;
                var content = `<img width="300" src="${props.picture_url}"/><h3>${props.title}</h3><p>${props.description}</p>`;
                layer.bindPopup(content);
              },
              pointToLayer: function (feature, latlng) {
                return L.marker(latlng, { icon: new LeafIcon({iconUrl: feature.properties.icon})});
              }
            }).addTo(map);
          });
      });
    </script>
  </head>
  <body>
    {% leaflet_map "main" %}
    {% if user.is_authenticated %}
    <div class="user">{{ user.get_username }} {{group}}</div>
    {% else %}
    <div class="user">log in pls</div>
    {% endif %} 
  </body>
</html>